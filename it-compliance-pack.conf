{
    "queries": {
        "unusual-process-name-linux": {
            "query": "SELECT COALESCE(REGEX_MATCH(p0.path, '.*/(.*)', 1), p0.path) AS pname, COALESCE(REGEX_MATCH(p0.path, '.*/.*\\.([a-z]{2,4})$', 1), '') AS pext, p0.pid AS p0_pid, p0.path AS p0_path, p0.name AS p0_name, p0.cmdline AS p0_cmd, p0.cwd AS p0_cwd, p0.euid AS p0_euid, p0_hash.sha256 AS p0_sha256, p0.parent AS p1_pid, p1.path AS p1_path, p1.name AS p1_name, p1.euid AS p1_euid, p1.cmdline AS p1_cmd, p1_hash.sha256 AS p1_sha256, p1.parent AS p2_pid, p2.name AS p2_name, p2.path AS p2_path, p2.cmdline AS p2_cmd, p2_hash.sha256 AS p2_sha256 FROM processes p0 LEFT JOIN hash p0_hash ON p0.path = p0_hash.path LEFT JOIN processes p1 ON p0.parent = p1.pid LEFT JOIN hash p1_hash ON p1.path = p1_hash.path LEFT JOIN processes p2 ON p1.parent = p2.pid LEFT JOIN hash p2_hash ON p2.path = p2_hash.path WHERE (pname LIKE '%kthread%' OR pname LIKE '%xprotect%' OR pname LIKE '%-help' OR pname LIKE '%acpi%' OR pname LIKE '%crypt%' OR pname LIKE '%flush%' OR pname LIKE '%initd%' OR pname LIKE '%irq%' OR pname LIKE '%kaudit%' OR pname LIKE '%kdev%' OR pname LIKE '%kdmp%' OR pname LIKE '%ksoft%' OR pname LIKE '%kswap%' OR pname LIKE '%kworker%' OR pname LIKE '%launchd%' OR pname LIKE '%nvme%' OR pname LIKE '%tasks%' OR pname LIKE '%thread%' OR pname LIKE '%user_dir%' OR pname LIKE '%xdg%' OR pname LIKE '%zswap%' OR pname LIKE 'cpu%' OR pname LIKE 'events%' OR pname LIKE 'idle_%' OR pname LIKE 'mm-%' OR pname LIKE 'nm_%' OR pname LIKE 'rcu%' OR REGEX_MATCH(pname, '([a-z]{16,})', 1) != '' OR REGEX_MATCH(pname, '([a-zA-Z0-9]{32,})', 1) != '' OR REGEX_MATCH(pname, '(\\w{40,})', 1) != '' OR REGEX_MATCH(pname, '([a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+[a-z]+[A-Z]+)', 1) != '' OR REGEX_MATCH(pname, '([a-z].*[A-Z].*\\d+.*[a-z].*\\d+)', 1) != '' OR REGEX_MATCH(pname, '(\\d.*[a-z].*\\d.*[a-z].*\\d+)', 1) != '' OR REGEX_MATCH(pname, '(\\d{5,})', 1) != '' OR REGEX_MATCH(pname, '^(\\d\\d)', 1) != '' OR REGEX_MATCH(pname, '^(\\W)', 1) != '' OR (REGEX_MATCH(pname, '(\\W)$', 1) != '' AND pname NOT LIKE '%)') AND pext NOT IN ('', 'gui', 'cli', 'us', 'node', 'com', 'test')) AND NOT pname LIKE '.%-wrapped' AND NOT pname LIKE '__debug_bin%' AND NOT pname LIKE '__Test%.test' AND pname NOT IN ('acpid', 'akonadi_followupreminder_agent', 'gmenudbusmenuproxy', 'irqbalance', 'kactivitymanagerd', 'nm-applet', 'nm-dispatcher', 'xdg-dbus-proxy', 'xdg-desktop-portal-gnome', 'xdg-desktop-portal-gtk', 'xdg-desktop-portal-kde', 'xdg-desktop-portal-regolith', 'xdg-desktop-portal-xapp', 'xdg-desktop-portal-wlr', 'xdg-desktop-portal', 'xdg-document-portal', 'xdg-permission-store', 'xwaylandvideobridge');",
            "interval": 3600,
            "description": "Detects processes with unusual executable names, such as those ending with .exe, .dll, or .sys, which are uncommon on Linux systems.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "minimal-socket-client-linux": {
            "query": "SELECT pos.protocol, pos.pid, pos.remote_address, pos.local_address, pos.local_port, pos.remote_port, pos.state, GROUP_CONCAT(DISTINCT pmm.path) AS libs, COUNT(DISTINCT pmm.path) AS lib_count, p0.path AS proc_path, p0.name AS proc_name, p0.start_time AS proc_start, p0.cmdline AS proc_cmd, p0.cwd AS proc_cwd, p0.cgroup_path AS proc_cgroup, p0.euid AS proc_euid, p0_hash.sha256 AS sha256 FROM processes p0 JOIN process_open_sockets pos ON p0.pid = pos.pid JOIN process_memory_map pmm ON p0.pid = pmm.pid LEFT JOIN hash p0_hash ON p0.path = p0_hash.path WHERE p0.path != '' AND p0.start_time < (strftime('%s', 'now') - 900) AND p0.path NOT IN ('/opt/bitnami/redis/bin/redis-server', '/usr/bin/cat', '/usr/bin/containerd', '/usr/bin/dash', '/usr/bin/docker-proxy', '/usr/bin/docker', '/usr/bin/fusermount3', '/usr/bin/i3blocks', '/usr/bin/kas', '/usr/bin/vmalert', '/usr/lib/electron/chrome-sandbox', '/usr/lib/snapd/snapd', '/usr/libexec/docker/docker-proxy', '/usr/local/bin/containerd', '/usr/local/bin/gitary', '/usr/sbin/acpid', '/usr/sbin/mcelog') AND p0.name NOT IN ('Brackets-node', 'chrome_crashpad', 'dhcpcd', 'gitaly', 'kas', 'redis-server', 'stern') AND p0.path NOT LIKE '/home/%/go/bin/%' AND pos.family != 1 AND pos.pid > 0 AND pos.state != 'LISTEN' AND pmm.path LIKE '%.so.%' AND NOT (pos.local_address = '127.0.0.1' AND pos.remote_address = '127.0.0.1') AND NOT proc_cgroup IN ('/system.slice/snapd.service') GROUP BY pos.pid HAVING lib_count IN (1, 2);",
            "interval": 3600,
            "description": "Identify root processes that have an open network socket & have very few shared libraries loaded.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-sysutils-linux": {
            "query": "SELECT pe.path AS p0_path, pe.time AS p0_time, REGEX_MATCH(pe.path, '.*/(.*)', 1) AS p0_name, TRIM(pe.cmdline) AS p0_cmd, pe.cwd AS p0_cwd, pe.pid AS p0_pid, p.cgroup_path AS p0_cgroup, pe.parent AS p1_pid, p1.cgroup_path AS p1_cgroup, TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd, COALESCE(p1.path, pe1.path) AS p1_path, COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash, REGEX_MATCH(COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name, COALESCE(p1.parent, pe1.parent) AS p2_pid, COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup, TRIM(COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)) AS p2_cmd, COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path, COALESCE(p1_p2_hash.path, pe1_p2_hash.path, pe1_pe2_hash.path) AS p2_hash, REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS p2_name, REGEX_MATCH(pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH(COALESCE(p1.path, pe1.path), '.*/(.*)', 1) || ',' || REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS exception_key FROM process_events pe, uptime LEFT JOIN processes p ON pe.pid = p.pid LEFT JOIN processes p1 ON pe.parent = p1.pid LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path LEFT JOIN process_events pe1 ON pe.parent = pe1.pid AND pe1.cmdline != '' LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid AND pe1_pe2.cmdline != '' LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path WHERE pe.time > (strftime('%s', 'now') -600) AND pe.cmdline != '' AND (pe.path IN ('/sbin/chattr', '/sbin/setenforce', '/sbin/sysctl', '/usr/bin/chattr', '/usr/bin/setenforce', '/usr/bin/sqlite3', '/usr/bin/sysctl', '/usr/sbin/chattr', '/usr/sbin/setenforce', '/usr/sbin/sysctl') OR (pe.path IN ('/ur/bin/uname', '/bin/uname') AND pe.cmdline LIKE '%uname -p')) AND p.parent > 0 GROUP BY pe.pid;",
            "interval": 3600,
            "description": "detect unexpected calls to system utilities in a Linux environment.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "dark_utilities_unix_executables_and_persistence": {
            "query": "SELECT pfd.pid, pfd.path, p.name, p.cmdline, p.parent, c.command, s.id, s.description FROM process_open_files pfd LEFT JOIN processes p ON p.pid = pfd.pid LEFT JOIN crontab c ON p.cmdline LIKE ('%' || c.command || '%') LEFT JOIN systemd_units s ON s.id = 'redis-client.service' WHERE pfd.path LIKE '%MEIPASS%';",
            "interval": 3600,
            "description": "Dark Utilities is a C2 platform offering a variety of services such as remote system access, DDoS capabilities, and cryptocurrency mining. Dark Utilities provides payloads consisting of code that is executed on victim systems, allowing them to be registered with the service and establish a command and control (C2) communications channel",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-elevated-children-events_linux": {
            "query": "SELECT file.mode AS p0_binary_mode, pe.path AS p0_path, pe.time AS p0_time, REGEX_MATCH(pe.path, '.*/(.*)', 1) AS p0_name, TRIM(pe.cmdline) AS p0_cmd, pe.cwd AS p0_cwd, pe.uid AS p0_uid, pe.euid AS p0_euid, pe.pid AS p0_pid, p.cgroup_path AS p0_cgroup, pe.parent AS p1_pid, p1.cgroup_path AS p1_cgroup, TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd, COALESCE(p1.path, pe1.path) AS p1_path, COALESCE(p1.euid, pe1.euid) AS p1_euid, COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash, REGEX_MATCH(COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name, COALESCE(p1.parent, pe1.parent) AS p2_pid, COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup, TRIM(COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)) AS p2_cmd, COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path, COALESCE(p1_p2_hash.path, pe1_p2_hash.path, pe1_pe2_hash.path) AS p2_hash, REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS p2_name FROM process_events pe LEFT JOIN file ON pe.path = file.path LEFT JOIN processes p ON pe.pid = pe.pid LEFT JOIN processes p1 ON pe.parent = p1.pid LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path LEFT JOIN process_events pe1 ON pe.parent = pe1.pid AND pe1.cmdline != '' LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid AND pe1_pe2.cmdline != '' LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path WHERE pe.pid IN (SELECT pid FROM process_events WHERE time > (strftime('%s', 'now') - 3600) AND syscall = "execve" AND euid < 500 AND (uid = 0 OR euid < uid)) AND pe.time > (strftime('%s', 'now') - 3600) AND pe.syscall = "execve" AND pe.euid < 500 AND (pe.euid < pe.uid OR pe.euid < p1_euid OR pe.euid < pe1.euid) AND pe.path NOT IN ('/bin/ps', '/opt/1Password/1Password-KeyringHelper', '/usr/bin/doas', '/usr/bin/fusermount', '/usr/bin/fusermount3', '/usr/bin/gpg', '/usr/bin/gpgconf', '/usr/bin/gpgsm', '/usr/bin/i3lock', '/usr/bin/login', '/usr/bin/nvidia-modprobe', '/usr/bin/top', '/usr/bin/unix_chkpwd', '/usr/lib/slack/chrome-sandbox', '/usr/lib/snapd/snap-confine', '/usr/lib/snapd/snap-update-ns', '/usr/lib/Xorg.wrap', '/usr/lib/xorg/Xorg.wrap') AND pe.path NOT LIKE '/nix/store/%/bin/dhcpcd' AND pe.path NOT LIKE '/nix/store/%/bin/sudo' AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine' AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns' AND NOT p1_cmd IN ('/bin/sh -c /usr/bin/pkexec /usr/share/apport/apport-gtk') AND NOT p0_cmd = '/usr/bin/pkexec /usr/lib/update-notifier/package-system-locked' AND NOT (p0_name = 'polkit-agent-helper-1' AND p1_path IN ('/usr/bin/gnome-shell', '/usr/lib/gvfsd', '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1')) AND NOT (p0_name = 'fusermount3' AND p1_path = '/usr/lib/xdg-document-portal') AND NOT (p0_name IN ('dash', 'pkexec') AND p1_path = '/usr/bin/update-notifier') AND NOT (p.cgroup_path = "/init.scope" AND p1.cgroup_path != "/init.scope") AND NOT p.cgroup_path LIKE '/system.slice/docker-%' AND NOT p1.cgroup_path LIKE '/system.slice/docker-%' GROUP BY pe.pid;",
            "interval": 3600,
            "description": "Detect unexpected privilege escalation, specifically where a child process has elevated permissions compared to its parent.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-global-lock": {
            "query": "SELECT *, CONCAT(MIN(file.uid, 500), ",", file.gid, ",", file.path, ",", file.type, ',', mode) AS exception_key FROM file WHERE (path LIKE "/dev/mqueue/.%.lock" OR path LIKE "/dev/mqueue/%.lock" OR path LIKE "/dev/shm/.%.lock" OR path LIKE "/dev/shm/%.lock" OR path LIKE "/tmp/.%.lock" OR path LIKE "/tmp/%.lock" OR path LIKE "/var/run/.%.lock" OR path LIKE "/var/run/%.lock" OR path LIKE "/var/tmp/.%.lock" OR path LIKE "/var/tmp/%.lock") AND exception_key NOT IN ('0,0,/var/run/apport.lock,regular,0600', '0,0,/var/run/dnf-metadata.lock,regular,0644', '0,0,/var/run/ublue-update.lock,regular,0755', '0,0,/var/run/ufw.lock,regular,0644', '0,0,/var/run/unattended-upgrades.lock,regular,0640', '0,0,/var/run/xtables.lock,regular,0600', '0,1,/var/run/prl_desktop_services_foreground.lock,regular,0644', '0,1,/var/run/prl_desktop_services.lock,regular,0644', '0,1,/var/run/VMware Fusion Services.lock,regular,0600', '0,1,/var/run/xv-update-resolv-conf.lock,regular,0600', '0,1001,/var/run/keyd.socket.lock,regular,0600', '500,0,/tmp/mysql.sock.lock,regular,0600', '500,0,/tmp/mysqlx.sock.lock,regular,0600', '500,0,/tmp/write.lock,regular,0644', '500,1000,/tmp/golangci-lint.lock,regular,0600', '500,1001,/tmp/nwg-dock.lock,regular,0600', '74,0,/tmp/mysql.sock.lock,regular,0600', '74,0,/tmp/mysqlx.sock.lock,regular,0600') AND NOT exception_key LIKE '500,0,/tmp/.s.PGSQL.%.lock,regular,0600' AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0644' AND NOT exception_key LIKE '500,1000,/tmp/keepassxc-%.lock,regular,0664' AND NOT exception_key LIKE '500,1000,/tmp/vscode-remote-ssh-%-install.lock,regular,0664';",
            "interval": 3600,
            "description": "detect unexpected world-readable lock files on POSIX-compliant systems. It focuses on lock files located in temporary directories such as /tmp, /var/run, /dev/shm, and others .",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "exotic-command-events-linux": {
            "query": "SELECT pe.path AS p0_path, pe.time AS p0_time, pe.uptime AS p0_uptime, REGEX_MATCH(pe.path, '.*/(.*)', 1) AS p0_name, TRIM(pe.cmdline) AS p0_cmd, pe.cwd AS p0_cwd, pe.pid AS p0_pid, p.cgroup_path AS p0_cgroup, pe.parent AS p1_pid, p1.cgroup_path AS p1_cgroup, TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd, COALESCE(p1.path, pe1.path) AS p1_path, COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash, REGEX_MATCH(COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name, COALESCE(p1.parent, pe1.parent) AS p2_pid, COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup, TRIM(COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)) AS p2_cmd, COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path, REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS p2_name, REGEX_MATCH(pe.path, '.*/(.*)', 1) || ',' || MIN(pe.euid, 500) || ',' || REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS exception_key FROM process_events pe LEFT JOIN processes p ON pe.pid = p.pid LEFT JOIN processes p1 ON pe.parent = p1.pid AND p1.start_time <= pe.time LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path LEFT JOIN process_events pe1 ON pe.parent = pe1.pid AND pe1.time <= pe.time AND pe1.cmdline != "" AND pe1.cwd != "" LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid AND p1_p2.start_time <= p1.start_time LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid AND pe1_p2.start_time <= pe1.time LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid AND pe1_pe2.cmdline != "" AND pe1_pe2.cwd != "" WHERE pe.time > (strftime('%s', 'now') -600) AND pe.cmdline != "" AND pe.cwd != "" AND (p0_name IN ('bitspin','bpftool','cpuminer-multi','cpuminer','dnscat2','esxcli','heyoka','httpdns','incbit','insmod','iodine','kmod','lushput','minerd','mkfifo','msfvenom','nc','nstx','rsh','rshell','socat','tuns','vim-cmd','xmrig') OR p0_name LIKE '%attack%' OR p0_name LIKE '%pwn%' OR p0_cmd LIKE '%cat /dev/null >%' OR p0_cmd LIKE '%chattr -i%' OR p0_cmd LIKE '%chrome%-load-extension%' OR p0_cmd LIKE '%dd if=/dev/%' OR p0_cmd LIKE '%iptables -F%' OR p0_cmd LIKE '%iptables -P % ACCEPT%' OR p0_cmd LIKE '%iptables stop' OR p0_cmd LIKE '%setenforce 0' OR p0_cmd LIKE '%truncate -s0 %' OR p0_cmd LIKE '%ufw disable%' OR (INSTR(p0_cmd, 'history') > 0 AND p0_cmd LIKE '%history' AND p0_cmd NOT LIKE 'man %') OR p0_cmd LIKE '%.aws/%' OR p0_cmd LIKE '%.config/%chrome%' OR p0_cmd LIKE '%.config%gcloud%' OR p0_cmd LIKE '%ld.so.preload%' OR p0_cmd LIKE '%nohup%tmp%' OR p0_cmd LIKE '%pkill -f%' OR p0_cmd LIKE '%systemctl disable firewalld%' OR p0_cmd LIKE '%systemctl stop firewalld%' OR p0_cmd LIKE '%tar % .%' OR p0_cmd LIKE '%tar %/.%' OR p0_cmd LIKE '%touch -r%' OR p0_cmd LIKE '%touch%acmr%' OR p0_cmd LIKE '%urllib.urlopen%' OR (p0_cmd LIKE '%xargs kill -9%' AND pe.euid = 0) OR p0_cmd LIKE '%@reboot%crontab%' OR p0_cmd LIKE '%/dev/%cp/%' OR p0_cmd LIKE '%echo%|%base64%-d% %|%' OR p0_cmd LIKE '%fsockopen%' OR p0_cmd LIKE '%monero%' OR p0_cmd LIKE '%nanopool%' OR p0_cmd LIKE '%nicehash%' OR p0_cmd LIKE '%nohup /bin/bash%' OR p0_cmd LIKE '%openssl%quiet%' OR p0_cmd LIKE '%pty.spawn%' OR p0_cmd LIKE '%stratum%' OR p0_cmd LIKE '%UserKnownHostsFile=/dev/null%' OR (p0_cmd LIKE '%sh -i' AND NOT p1_name IN ('sh', 'java')) OR p0_cmd LIKE '%SOCK_STREAM%' OR INSTR(p0_cmd, 'Socket.') > 0 OR (p0_cmd LIKE '%tail -f /dev/null%' AND p.cgroup_path NOT LIKE '/system.slice/docker-%')) AND NOT (pe.path IN ('/usr/bin/kmod', '/bin/kmod') AND p1_path = '/usr/lib/systemd/systemd' AND p1_cmd = '/sbin/init') AND NOT (pe.path IN ('/usr/bin/kmod', '/bin/kmod') AND p1_name IN ('dockerd','firewalld','kube-proxy','mkinitramfs','systemd')) AND NOT (p0_cmd LIKE '/usr/bin/modprobe %' AND p1_cgroup = '/system.slice/firewalld.service') AND NOT (pe.path IN ('/usr/bin/kmod', '/bin/kmod') AND pe.uptime < 15) AND NOT (pe.path = '/usr/bin/mkfifo' AND (p0_cmd LIKE '%/org.gpgtools.log.%/fifo' OR p0_cmd LIKE 'mkfifo -- %/gitstatus.POWERLEVEL9K%.fifo' OR p0_cmd LIKE '%/p10k.%')) AND NOT p0_cmd IN ('lsmod','dd if=/dev/stdin conv=unblock cbs=79','/usr/bin/socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket','socat STDIN UNIX-CONNECT:/run/user/1000/kwallet5.socket') AND NOT p0_cmd LIKE '%/usr/bin/cmake%Socket%' AND NOT p0_cmd LIKE '%modprobe -va%' AND NOT p0_cmd LIKE '%modprobe aufs' AND NOT p0_cmd LIKE '%modprobe nf_nat_netbios_ns' AND NOT p0_cmd LIKE '%modprobe overlay' AND NOT p0_cmd LIKE '%touch -r /tmp/cc%.o %' AND NOT p0_cmd LIKE 'find . -executable -type f -name %grep -l GNU Libtool%touch -r%' AND NOT p0_cmd LIKE 'modinfo -k%' AND NOT p0_cmd LIKE 'modprobe --all%' AND NOT p0_cmd LIKE 'modprobe -ab%' AND NOT p0_cmd LIKE 'pkill -f cut -c3%' AND NOT p0_name IN ('ar','cc1','cc1plus','cmake','compile') AND NOT exception_key IN ('bash,0,bash,containerd-shim-runc-v2','bash,500,ninja,bash','bwrap,500,melange,dash','chrome_crashpad_handler,500,systemd,systemd','grep,500,fish,konsole','kmod,0,incusd,systemd','ls,500,zsh,alacritty','nc,500,fish,konsole','tar,0,incusd,systemd');",
            "interval": 3600,
            "description": "checks for processes and their command-lines matching known suspicious patterns Commands that:Disable firewalls:Modify permissions or security settings: '%setenforce 0%', '%chattr -i%'Cryptominer activity: '%monero%', '%nanopool%', '%nicehash%', '%stratum%'Unusual file operations: '%truncate -s0 %', '%cat /dev/null >%', '%tar %/.%'",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-fetcher-parent-events": {
            "query": "SELECT file.mode AS p0_binary_mode, pe.path AS p0_path, pe.time AS p0_time, REGEX_MATCH(pe.path, '.*/(.*)', 1) AS p0_name, TRIM(pe.cmdline) AS p0_cmd, pe.cwd AS p0_cwd, pe.uid AS p0_uid, pe.euid AS p0_euid, pe.pid AS p0_pid, p.cgroup_path AS p0_cgroup, pe.parent AS p1_pid, p1.cgroup_path AS p1_cgroup, TRIM(COALESCE(p1.cmdline, pe1.cmdline)) AS p1_cmd, COALESCE(p1.path, pe1.path) AS p1_path, COALESCE(p1.euid, pe1.euid) AS p1_euid, COALESCE(p_hash1.sha256, pe_hash1.sha256) AS p1_hash, REGEX_MATCH(COALESCE(p1.path, pe1.path), '.*/(.*)', 1) AS p1_name, COALESCE(p1.parent, pe1.parent) AS p2_pid, COALESCE(p1_p2.cgroup_path, pe1_p2.cgroup_path) AS p2_cgroup, TRIM(COALESCE(p1_p2.cmdline, pe1_p2.cmdline, pe1_pe2.cmdline)) AS p2_cmd, COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path) AS p2_path, COALESCE(p1_p2_hash.path, pe1_p2_hash.path, pe1_pe2_hash.path) AS p2_hash, REGEX_MATCH(COALESCE(p1_p2.path, pe1_p2.path, pe1_pe2.path), '.*/(.*)', 1) AS p2_name FROM process_events pe LEFT JOIN file ON pe.path = file.path LEFT JOIN processes p ON pe.pid = pe.pid LEFT JOIN processes p1 ON pe.parent = p1.pid LEFT JOIN hash p_hash1 ON p1.path = p_hash1.path LEFT JOIN process_events pe1 ON pe.parent = pe1.pid AND pe1.cmdline != '' LEFT JOIN hash pe_hash1 ON pe1.path = pe_hash1.path LEFT JOIN processes p1_p2 ON p1.parent = p1_p2.pid LEFT JOIN processes pe1_p2 ON pe1.parent = pe1_p2.pid LEFT JOIN process_events pe1_pe2 ON pe1.parent = pe1_p2.pid AND pe1_pe2.cmdline != '' LEFT JOIN hash p1_p2_hash ON p1_p2.path = p1_p2_hash.path LEFT JOIN hash pe1_p2_hash ON pe1_p2.path = pe1_p2_hash.path LEFT JOIN hash pe1_pe2_hash ON pe1_pe2.path = pe1_pe2_hash.path WHERE pe.pid IN (SELECT pid FROM process_events WHERE time > (strftime('%s', 'now') - 3600) AND syscall = "execve" AND euid < 500 AND (uid = 0 OR euid < uid)) AND pe.time > (strftime('%s', 'now') -3600) AND pe.syscall = "execve" AND pe.euid < 500 AND (pe.euid < pe.uid OR pe.euid < p1_euid OR pe.euid < pe1.euid) AND pe.path NOT IN ('/bin/ps', '/opt/1Password/1Password-KeyringHelper', '/usr/bin/doas', '/usr/bin/fusermount', '/usr/bin/fusermount3', '/usr/bin/gpg', '/usr/bin/gpgconf', '/usr/bin/gpgsm', '/usr/bin/i3lock', '/usr/bin/login', '/usr/bin/nvidia-modprobe', '/usr/bin/top', '/usr/bin/unix_chkpwd', '/usr/lib/slack/chrome-sandbox', '/usr/lib/snapd/snap-confine', '/usr/lib/snapd/snap-update-ns', '/usr/lib/Xorg.wrap', '/usr/lib/xorg/Xorg.wrap') AND pe.path NOT LIKE '/nix/store/%/bin/dhcpcd' AND pe.path NOT LIKE '/nix/store/%/bin/sudo' AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-confine' AND pe.path NOT LIKE '/snap/snapd/%/usr/lib/snapd/snap-update-ns' AND NOT p1_cmd IN ('/bin/sh -c /usr/bin/pkexec /usr/share/apport/apport-gtk') AND NOT p0_cmd = '/usr/bin/pkexec /usr/lib/update-notifier/package-system-locked' AND NOT (p0_name = 'polkit-agent-helper-1' AND p1_path IN ('/usr/bin/gnome-shell', '/usr/lib/gvfsd', '/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1')) AND NOT (p0_name = 'fusermount3' AND p1_path = '/usr/lib/xdg-document-portal') AND NOT (p0_name IN ('dash', 'pkexec') AND p1_path = '/usr/bin/update-notifier') AND NOT (p.cgroup_path = "/init.scope" AND p1.cgroup_path != "/init.scope") AND NOT p.cgroup_path LIKE '/system.slice/docker-%' AND NOT p1.cgroup_path LIKE '/system.slice/docker-%' GROUP BY pe.pid;",
            "interval": 3600,
            "description": "identify suspicious process activities on a POSIX system, specifically focusing on the use of known fetch tools (like curl, wget, ftp, and tftp) to transfer files",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "low-fd-socket": {
            "query": "SELECT pos.protocol, pos.pid, pos.remote_address, pos.local_address, pos.local_port, pos.remote_port, pos.state, p0.pid AS p0_pid, p0.path AS p0_path, p0.name AS p0_name, p0.start_time AS p0_start, p0.cmdline AS p0_cmd, p0.cwd AS p0_cwd, p0.cgroup_path AS p0_cgroup, p0.euid AS p0_euid, p0_hash.sha256 AS p0_sha256, p0.parent AS p1_pid, p1.path AS p1_path, p1.name AS p1_name, p1.start_time AS p1_start, p1.euid AS p1_euid, p1.cmdline AS p1_cmd, p1_hash.sha256 AS p1_sha256, p1.parent AS p2_pid, p2.name AS p2_name, p2.start_time AS p2_start, p2.path AS p2_path, p2.cmdline AS p2_cmd, p2_hash.sha256 AS p2_sha256 FROM process_open_sockets pos JOIN processes p0 ON pos.pid = p0.pid LEFT JOIN hash p0_hash ON p0.path = p0_hash.path LEFT JOIN processes p1 ON p0.parent = p1.pid LEFT JOIN hash p1_hash ON p1.path = p1_hash.path LEFT JOIN processes p2 ON p1.parent = p2.pid LEFT JOIN hash p2_hash ON p2.path = p2_hash.path WHERE pos.fd < 3 AND pos.family != 1 AND p0.path NOT IN ('/Applications/NetSpot.app/Contents/MacOS/NetSpot', '/Library/Application Support/Viscosity/viscosity_openvpn', '/usr/bin/skopeo', '/usr/libexec/bootpd', '/usr/libexec/pcp/bin/pmcd', '/usr/local/bin/velociraptor');",
            "interval": 3600,
            "description": "detect potentially suspicious behavior related to processes opening low-numbered file descriptor (FD) sockets.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-setuid-binaries": {
            "query": "SELECT GROUP_CONCAT(path) AS paths, gid, uid, mode, type, size, data, sha256 FROM (SELECT file.path, file.gid, file.uid, file.inode, file.mode, file.type, file.size, magic.data, hash.sha256 FROM file LEFT JOIN hash ON file.path = hash.path LEFT JOIN magic ON file.path = magic.path WHERE file.directory IN ('/bin','/etc','/opt/google-cloud-sdk/bin','/opt/homebrew/bin','/opt/homebrew/sbin','/sbin','/tmp','/usr/bin','/usr/lib','/usr/lib/jvm/default/bin','/usr/lib64','/usr/libexec','/usr/local/bin','/usr/local/lib','/usr/local/lib64','/usr/local/libexec','/usr/local/sbin','/usr/sbin','/var/lib','/var/tmp') AND type = 'regular' AND mode NOT LIKE '0%' AND mode NOT LIKE '1%' AND mode NOT LIKE '2%' AND NOT (mode LIKE '4%11' AND uid = 0 AND gid = 0 AND file.path IN ('/bin/bwrap','/bin/cdda2wav','/bin/cdrecord','/bin/chfn','/bin/chsh','/bin/icedax','/bin/mount.nfs','/bin/mount.nfs4','/bin/readcd','/bin/readom','/bin/rscsi','/bin/staprun','/bin/sudo','/bin/sudoedit','/bin/umount.nfs','/bin/umount.nfs4','/bin/wodim','/sbin/cdda2wav','/sbin/cdrecord','/sbin/icedax','/sbin/mount.nfs','/sbin/mount.nfs4','/sbin/readcd','/sbin/readom','/sbin/rscsi','/sbin/umount.nfs','/sbin/umount.nfs4','/sbin/userhelper','/sbin/wodim','/usr/bin/bwrap','/usr/bin/cdda2wav','/usr/bin/cdrecord','/usr/bin/chfn','/usr/bin/chsh','/usr/bin/icedax','/usr/bin/mount.nfs','/usr/bin/mount.nfs4','/usr/bin/readcd','/usr/bin/readom','/usr/bin/rscsi','/usr/bin/staprun','/usr/bin/sudo','/usr/bin/sudoedit','/usr/bin/umount.nfs','/usr/bin/umount.nfs4','/usr/bin/wodim','/usr/libexec/security_authtrampoline','/usr/sbin/cdda2wav','/usr/sbin/cdrecord','/usr/sbin/icedax','/usr/sbin/mount.nfs','/usr/sbin/mount.nfs4','/usr/sbin/readcd','/usr/sbin/readom','/usr/sbin/rscsi','/usr/sbin/umount.nfs','/usr/sbin/umount.nfs4','/usr/sbin/userhelper','/usr/sbin/wodim')) AND NOT (mode LIKE '4%55' AND uid = 0 AND gid = 0 AND file.path IN ('/bin/at','/bin/atq','/bin/atrm','/bin/bwrap','/bin/chage','/bin/chfn','/bin/chsh','/bin/crontab','/bin/doas','/bin/expiry','/bin/firejail','/bin/fusermount-glusterfs','/bin/fusermount','/bin/fusermount3','/bin/gpasswd','/bin/keybase-redirector','/bin/ksu','/bin/mount','/bin/mullvad-exclude','/bin/ndisc6','/bin/newgidmap','/bin/newgrp','/bin/newuidmap','/bin/ntfs-3g','/bin/nvidia-modprobe','/bin/passwd','/bin/pkexec','/bin/ps','/bin/rdisc6','/bin/rltraceroute6','/bin/schroot','/bin/sg','/bin/su','/bin/sudo','/bin/sudoedit','/bin/suexec','/bin/ubuntu-core-launcher','/bin/umount','/bin/vmware-user-suid-wrapper','/bin/vmware-user','/sbin/chage','/sbin/chfn','/sbin/chsh','/sbin/crontab','/sbin/doas','/sbin/expiry','/sbin/firejail','/sbin/fusermount','/sbin/fusermount3','/sbin/gpasswd','/sbin/grub2-set-bootflag','/sbin/ksu','/sbin/mount.cifs','/sbin/mount.nfs','/sbin/mount.nfs4','/sbin/mount.ntfs-3g','/sbin/mount.ntfs','/sbin/mount.smb3','/sbin/mount','/sbin/mullvad-exclude','/sbin/ndisc6','/sbin/newgrp','/sbin/nvidia-modprobe','/sbin/pam_timestamp_check','/sbin/passwd','/sbin/pkexec','/sbin/rdisc6','/sbin/rltraceroute6','/sbin/sg','/sbin/su','/sbin/sudo','/sbin/sudoedit','/sbin/suexec','/sbin/umount.nfs','/sbin/umount.nfs4','/sbin/umount','/sbin/unix_chkpwd','/sbin/usernetctl','/usr/bin/at','/usr/bin/atq','/usr/bin/atrm','/usr/bin/batch','/usr/bin/bwrap','/usr/bin/chage','/usr/bin/chfn','/usr/bin/chsh','/usr/bin/crontab','/usr/bin/doas','/usr/bin/expiry','/usr/bin/firejail','/usr/bin/fusermount-glusterfs','/usr/bin/fusermount','/usr/bin/fusermount3','/usr/bin/gpasswd','/usr/bin/keybase-redirector','/usr/bin/ksu','/usr/bin/login','/usr/bin/mount','/usr/bin/mullvad-exclude','/usr/bin/ndisc6','/usr/bin/newgidmap','/usr/bin/newgrp','/usr/bin/newuidmap','/usr/bin/ntfs-3g','/usr/bin/nvidia-modprobe','/usr/bin/passwd','/usr/bin/pkexec','/usr/bin/quota','/usr/bin/rdisc6','/usr/bin/rltraceroute6','/usr/bin/schroot','/usr/bin/sg','/usr/bin/su','/usr/bin/sudo','/usr/bin/sudoedit','/usr/bin/suexec','/usr/bin/top','/usr/bin/ubuntu-core-launcher','/usr/bin/umount','/usr/bin/vmware-user-suid-wrapper','/usr/bin/vmware-user')) AND NOT (mode = '4754' AND uid = 0 AND gid = 30 AND file.path IN ('/usr/sbin/pppd', '/sbin/pppd')) AND NOT (mode = '6755' AND uid = 0 AND gid = 0 AND file.path IN ('/bin/mount.cifs','/bin/mount.smb3','/bin/unix_chkpwd','/sbin/mount.cifs','/sbin/mount.smb3','/sbin/unix_chkpwd','/usr/bin/mount.cifs','/usr/bin/mount.smb3','/usr/bin/unix_chkpwd','/usr/lib/xtest','/usr/lib64/xtest','/usr/sbin/mount.cifs','/usr/sbin/mount.smb3','/usr/sbin/unix_chkpwd')) AND NOT (mode = '4110' AND uid = 0 AND gid = 156 AND file.path IN ('/bin/staprun', '/usr/bin/staprun'))) GROUP BY inode;",
            "interval": 3600,
            "description": "detect files with unusual permission modes .Setuid binaries are programs that run with the owner's privileges (usually root) !",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-env-values-linux": {
            "query": "SELECT pe.key, pe.value, LENGTH(pe.value) AS value_len, p0.pid AS p0_pid, p0.path AS p0_path, p0.name AS p0_name, p0.cmdline AS p0_cmd, p0.cwd AS p0_cwd, p0.cgroup_path AS p0_cgroup, p0.euid AS p0_euid, p0_hash.sha256 AS p0_sha256, p0.parent AS p1_pid, p1.path AS p1_path, p1.name AS p1_name, p1.cmdline AS p1_cmd, p1_hash.sha256 AS p1_sha256, p1.parent AS p2_pid, p2.name AS p2_name, p2.path AS p2_path, p2.cmdline AS p2_cmd, p2_hash.sha256 AS p2_sha256 FROM processes p0 JOIN process_envs pe ON p0.pid = pe.pid LEFT JOIN file f ON p0.path = f.path LEFT JOIN hash p0_hash ON p0.path = p0_hash.path LEFT JOIN processes p1 ON p0.parent = p1.pid LEFT JOIN hash p1_hash ON p1.path = p1_hash.path LEFT JOIN processes p2 ON p1.parent = p2.pid LEFT JOIN hash p2_hash ON p2.path = p2_hash.path WHERE p0.start_time > (strftime('%s', 'now') - 300) AND (pe.key = 'HISTFILE' AND NOT pe.value LIKE '/home/%/.%_history' AND NOT pe.value LIKE '~/.%_history' AND NOT pe.value LIKE '%/.histfile' AND NOT pe.value LIKE '/root/.%_history') OR (pe.key = 'LD_PRELOAD' AND NOT pe.value = '' AND NOT p0.path LIKE '%/firefox' AND NOT pe.value IN ('/opt/splunkforwarder/lib/libdlwrapper.so', '/run/host/usr/lib/extest/libextest.so', '/tmp/preload.so', '/usr/lib/extest/libextest.so', '/usr/lib/libjemalloc.so', '/usr/lib/libsnmallocshim-checks-memcpy-only.so', '/usr/lib/libsnmallocshim.so', '/usr/local/lib/libmimalloc.so', 'libfakeroot.so') AND NOT p0.cgroup_path LIKE '/system.slice/docker-%' AND NOT pe.value LIKE ':/home/%/.local/share/Steam' AND NOT pe.value LIKE ':/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so:/home/%/.local/share/Steam/ubuntu%/gameoverlayrenderer.so' AND NOT pe.value LIKE ':/home/%/.var/app/com.valvesoftware.Steam/%' AND NOT pe.value LIKE ':/snap/%' AND NOT pe.value LIKE '/app/bin/%' AND NOT pe.value LIKE 'libmozsandbox.so%') OR (LENGTH(pe.value) > 1024 AND pe.key != 'LS_COLORS' AND pe.key != 'HTTP_AUTH' AND f.mode IS NOT NULL AND f.mode NOT LIKE '0%');",
            "interval": 3600,
            "description": "Identify processes setting variables such as HISTFILE , LD_PRELOAD , or others that can bypass security checks or mask malicious activities",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-icmp-socket": {
            "query": "SELECT pop.pid AS p0_pid, pop.socket, pop.local_address, pop.remote_address, p0.path AS p0_path, p0.name AS p0_name, p0.cmdline AS p0_cmd, p0.cwd AS p0_cwd, p0.cgroup_path AS p0_cgroup, p0.euid AS p0_euid, p0_hash.sha256 AS p0_sha256, p0.parent AS p1_pid, p1.path AS p1_path, p1.name AS p1_name, p1.cmdline AS p1_cmd, p1_hash.sha256 AS p1_sha256, p1.parent AS p2_pid, p2.name AS p2_name, p2.path AS p2_path, p2.cmdline AS p2_cmd, p2_hash.sha256 AS p2_sha256 FROM process_open_sockets pop LEFT JOIN processes p0 ON pop.pid = p0.pid LEFT JOIN hash p0_hash ON p0.path = p0_hash.path LEFT JOIN processes p1 ON p0.parent = p1.pid LEFT JOIN hash p1_hash ON p1.path = p1_hash.path LEFT JOIN processes p2 ON p1.parent = p2.pid LEFT JOIN hash p2_hash ON p2.path = p2_hash.path WHERE pop.family = 2 AND pop.protocol = 1 AND p0.name NOT IN ('ping') GROUP BY p0_pid;",
            "interval": 3600,
            "description": "Detect processes using ICMP for communication. Malicious software or attackers may exploit ICMP for command-and-control",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "unexpected-tmp-executables-linux": {
            "query": "SELECT DISTINCT file.path, uid, gid, mode, REGEX_MATCH (file.filename, '.*\.(.*?)$', 1) AS extension, file.btime, file.ctime, file.mtime, file.size, hash.sha256, magic.data FROM file LEFT JOIN hash on file.path = hash.path LEFT JOIN magic ON file.path = magic.path WHERE file.path IN (SELECT DISTINCT path FROM file WHERE (file.directory = '/tmp' OR file.directory LIKE '/tmp/.%') AND NOT file.directory LIKE '%/../%' AND NOT file.directory LIKE '%/./%' AND NOT (strftime('%s', 'now') - ctime) < 60 AND file.type = 'regular' AND (file.mode LIKE '%7%' or file.mode LIKE '%5%' or file.mode LIKE '%1%') AND NOT (uid > 500 AND (file.path LIKE '%/go-build%' OR file.directory LIKE '/tmp/%/out' OR file.path IN ('/tmp/mission', '/tmp/mkinitramfs') OR file.path LIKE '/tmp/GoLand/___go_build_%_go' OR file.path LIKE '/tmp/ko%/out' OR file.path LIKE '/tmp/lima/%/out/%' OR file.path LIKE '/tmp/wolfi%' OR file.path LIKE '%-release%/%' OR file.path LIKE '%/bin/%' OR file.path LIKE '/tmp/%.sh' OR file.path LIKE '%/checkout/%' OR file.path LIKE '%/ci/%' OR file.path LIKE '%/configure' OR file.path LIKE '%/debug/%' OR file.path LIKE '%/dist/%' OR file.path LIKE '%/flow/%.npmzS_cacachezStmpzSgit-clone%' OR file.path LIKE '%/git/%' OR file.path LIKE '%/github/%' OR file.path LIKE '%/go.%.sum' OR file.path LIKE '%/guile-%/guile-%' OR file.path LIKE '%/ko/%' OR file.path LIKE '%/kots/%' OR file.path LIKE '%/melange-guest-%' OR file.path LIKE '%/pdf-tools/%' OR file.path LIKE '%/Rakefile' OR file.path LIKE '%/site-packages/markupsafe/_speedups.cpython-%' OR file.path LIKE '%/src/%' OR file.path LIKE '%/target/%' OR file.path LIKE '%/terraformer/%' OR file.path LIKE '%/tmp/epdf%' OR file.path LIKE '%integration_test%' OR file.path LIKE '%test_script' OR file.path LIKE "/tmp/lima/%" OR file.path LIKE "%/%/gradlew" OR file.path LIKE "%/bin/bash" OR file.path LIKE "%/bin/busybox" OR file.path LIKE "%/lib/%.so.%" OR file.path LIKE "%/lib/%.so" OR file.path LIKE "%/melange%"))) AND NOT (file.path LIKE "%/lib/%.so" OR file.path LIKE '/tmp/staged-updates%launcher' OR file.path LIKE "%/bin/bash" OR file.path LIKE "%/bin/busybox" OR file.path LIKE "%/lib/%.so.%" OR file.path LIKE "%/lib64/%.so.%" OR file.path LIKE "%/lib64/%.so" OR file.path LIKE "%/melange%" OR file.path LIKE "%/sbin/%") AND NOT (file.directory LIKE '/tmp/tmp%' AND gid = 0 AND uid > 300 AND uid < 350) AND NOT (file.directory LIKE '/tmp/babel-%/sh-script-%' AND gid > 900 AND uid = 1000 AND size < 1024) AND NOT (gid > 900 AND uid = 1000 AND (file.directory LIKE '/tmp/%/test' OR file.directory LIKE '/tmp/%/testdata')) AND NOT (uid > 500 AND file.path LIKE '/tmp/terraform_%/terraform') AND NOT (file.path LIKE '/tmp/%compressed' AND size < 4000 AND uid > 500) AND NOT (file.type = 'regular' AND size < 10) AND NOT (file.path LIKE '/tmp/tmp.%/ssl/default-fake-certificate.pem' AND file.size < 4096) AND NOT (file.path LIKE '/tmp/%' AND file.uid > 500 AND (file.filename LIKE "%ctl" OR file.filename LIKE "%adm" OR file.filename LIKE "%-cli")) AND NOT (file.directory LIKE "%/lib" OR file.directory LIKE "%/lib64" AND file.uid > 500 AND (file.filename LIKE "%.so.%" OR file.filename LIKE "%.so")) AND NOT (file.uid > 500 AND magic.data IS NOT NULL AND (magic.data IN ("POSIX shell script, ASCII text executable", "libtool library file, ASCII text", "ASCII text", "JSON data") OR magic.data LIKE 'ELF 32-bit LSB pie executable, ARM, EABI5%' OR magic.data LIKE 'ELF 64-bit MSB pie executable, IBM S/390%' OR magic.data LIKE 'Linux kernel %' OR magic.data LIKE 'symbolic link to %' OR magic.data LIKE "ELF 64-bit LSB shared object,%" OR magic.data LIKE "gzip compressed data%" OR magic.data LIKE "Unicode text%")) AND NOT (file.uid = 0 AND magic.data IS NOT NULL AND (magic.data LIKE 'symbolic link to %' OR magic.data IN ("ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so.1, stripped", "libtool library file, ASCII text"))) AND NOT (file.size < 65000 AND file.uid > 500 AND file.filename LIKE "%.%") AND extension IN ('adoc','api','authn','bat','erb','iam','java','js','json','log','nib','pem','perl','pl','pub','py','rb','registry','script','sh','strings','txt','yaml','yml');",
            "interval": 3600,
            "description": "identify unexpected executable files in temporary directories on a Linux system, which are often used by malware droppers.",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
        "reverse-shell-socket": {
            "query": "SELECT DISTINCT p.pid, p.parent, p.name, p.path, p.cmdline, p.cwd, p.root, p.uid, p.gid, p.start_time, pos.remote_address, pos.remote_port, pos.local_address, pos.local_port, pp.cmdline, pp.path FROM process_open_files pof JOIN process_open_sockets pos USING (pid) LEFT JOIN processes p ON pof.pid = p.pid LEFT JOIN processes pp ON p.parent = pp.pid LEFT OUTER JOIN process_open_files ON p.pid = process_open_files.pid WHERE p.name IN ('sh', 'bash', 'perl', 'python') AND pos.remote_port > 0 AND NOT (p.path = '/usr/bin/bash' AND pp.cmdline LIKE 'pacman -S%');",
            "interval": 3600,
            "description": "detect processes that have an open remote port, meaning it is attempting to establish a network connection, indicate a reverse shell trying to connect back to an attacker's machine",
            "platform": "linux",
            "version": "2.0.0",
            "snapshot": true
        },
"test-query-linux": {
    "query": "SELECT u.username, u.uid, u.gid, u.description, p.port, p.address, p.pid, s.total_seconds AS uptime_seconds FROM users AS u LEFT JOIN listening_ports AS p ON p.port = 22 AND p.protocol = 'tcp' LEFT JOIN uptime AS s ON 1=1;",
    "interval": 30,
    "description": "Get user list, open SSH port, and system uptime.",
    "platform": "linux",
    "version": "2.0.0",
    "snapshot": true
  }
    }
}
